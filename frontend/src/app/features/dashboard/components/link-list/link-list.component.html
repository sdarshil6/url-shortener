<div class="dashboard-column">
  <div class="dashboard-header">
    <h2 class="dashboard-title">
      <span class="svg-icon" style="--url: url('assets/icons/grid.svg');"></span>
      Your Links
      <span class="count-badge" *ngIf="totalItems > 0">({{ totalItems }})</span>
    </h2>
    <button class="btn-refresh" (click)="refreshLinks()" title="Refresh link list">
      <span class="svg-icon" style="--url: url('assets/icons/refresh-cw.svg');"></span>
      <span>Refresh</span>
    </button>
  </div>

  <!-- Search and Filters -->
  <div class="controls-bar">
    <div class="search-box">
      <span class="svg-icon search-icon" style="--url: url('assets/icons/search.svg');" aria-hidden="true"></span>
      <input 
        type="text" 
        placeholder="Search by URL or short code..." 
        [(ngModel)]="searchQuery"
        (input)="onSearchInput($any($event.target).value)"
        class="search-input"
        aria-label="Search links by URL or short code"
      />
    </div>

    <div class="filter-controls">
      <div class="filter-group">
        <label for="sort-select" class="filter-label">Sort:</label>
        <select id="sort-select" [(ngModel)]="sortBy" (change)="onSortChange(sortBy)" class="filter-select" aria-label="Sort links by">
          <option value="created_at">Date</option>
          <option value="clicks">Clicks</option>
          <option value="expires_at">Expiry</option>
        </select>
        <button class="sort-order-btn" (click)="onSortChange(sortBy)" [attr.aria-label]="sortOrder === 'asc' ? 'Sort ascending' : 'Sort descending'" [title]="sortOrder === 'asc' ? 'Ascending' : 'Descending'">
          <span class="svg-icon" [style.--url]="sortOrder === 'asc' ? 'url(\'assets/icons/arrow-up.svg\')' : 'url(\'assets/icons/arrow-down.svg\')'" aria-hidden="true"></span>
        </button>
      </div>

      <div class="filter-group">
        <label for="filter-select" class="filter-label">Filter:</label>
        <select id="filter-select" [(ngModel)]="filterStatus" (change)="onFilterChange(filterStatus)" class="filter-select" aria-label="Filter links by status">
          <option [ngValue]="null">All</option>
          <option value="active">Active</option>
          <option value="expired">Expired</option>
        </select>
      </div>

      <button class="clear-filters-btn" (click)="clearFilters()" *ngIf="searchQuery || filterStatus" title="Clear filters" aria-label="Clear all filters">
        <span class="svg-icon" style="--url: url('assets/icons/x.svg');" aria-hidden="true"></span>
      </button>
    </div>
  </div>
  
  <!-- Loading State with Skeleton Loaders -->
  <div *ngIf="loading" class="skeleton-list" role="status" aria-live="polite" aria-label="Loading links">
    <app-skeleton-loader *ngFor="let i of [1,2,3,4,5]" type="card"></app-skeleton-loader>
  </div>

  <!-- Links List -->
  <ul class="links-list" *ngIf="!loading">
    <div *ngIf="links.length === 0" class="empty-state">
      <p *ngIf="!searchQuery && !filterStatus">No links present</p>
      <p *ngIf="searchQuery || filterStatus">No links match your filters</p>
    </div>
    
    <li *ngFor="let link of links" class="link-card fade-in">
      <div class="link-header">
        <div class="short-url">
          <a [href]="getShortUrl(link.url)" target="_blank" [title]="getShortUrl(link.url)">{{ getDisplayUrl(link.url) }}</a>
        </div>
        <button class="copy-btn btn-icon" (click)="copyToClipboard(link.url)" title="Copy short link" aria-label="Copy short link to clipboard">
          <span class="svg-icon" style="--url: url('assets/icons/copy.svg');" aria-hidden="true"></span>
        </button>
      </div>
      
      <p class="target-url" [title]="link.target_url">{{ link.target_url }}</p>
      
      <div class="link-footer">
        <div class="link-stats">
          <span title="Total clicks"><strong>{{ link.clicks }}</strong> Clicks</span>
          <span title="Link expiration">Exp: <strong>{{ getExpirationDisplay(link.expires_at) }}</strong></span>
        </div>
        <div class="link-actions">
          <div class="qr-code-container" (click)="openQRModal(link)" title="View QR Code" role="button" tabindex="0" (keydown.enter)="openQRModal(link)" (keydown.space)="openQRModal(link); $event.preventDefault()" aria-label="View QR code for this link">
            <img [src]="link.qr_code" alt="QR Code" class="qr-code-img" />
          </div>
          <button class="analytics-btn btn-icon" (click)="openAnalytics(link)" title="View Analytics" aria-label="View analytics for this link">
            <span class="svg-icon" style="--url: url('assets/icons/bar-chart.svg');" aria-hidden="true"></span>
          </button>
          <button class="edit-btn btn-icon" (click)="openEditModal(link)" title="Edit Link" aria-label="Edit this link">
            <span class="svg-icon" style="--url: url('assets/icons/edit.svg');" aria-hidden="true"></span>
          </button>
          <button class="delete-btn btn-icon" (click)="deleteLink(link)" title="Delete Link" aria-label="Delete this link">
            <span class="svg-icon" style="--url: url('assets/icons/trash.svg');" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </li>
  </ul>

  <!-- Pagination -->
  <div class="pagination" *ngIf="!loading && totalPages > 1" role="navigation" aria-label="Pagination navigation">
    <button 
      class="pagination-btn" 
      (click)="previousPage()" 
      [disabled]="currentPage === 1"
      title="Previous page"
      aria-label="Go to previous page"
    >
      <span class="svg-icon" style="--url: url('assets/icons/chevron-left.svg');" aria-hidden="true"></span>
    </button>

    <div class="page-numbers">
      <button 
        *ngFor="let page of getPageNumbers()" 
        class="page-btn"
        [class.active]="page === currentPage"
        [class.ellipsis]="page === -1"
        (click)="page !== -1 && goToPage(page)"
        [disabled]="page === -1"
        [attr.aria-label]="page === -1 ? null : 'Go to page ' + page"
        [attr.aria-current]="page === currentPage ? 'page' : null"
        [style.pointer-events]="page === -1 ? 'none' : 'auto'"
        [tabindex]="page === -1 ? -1 : 0"
      >
        {{ page === -1 ? '...' : page }}
      </button>
    </div>

    <button 
      class="pagination-btn" 
      (click)="nextPage()" 
      [disabled]="currentPage === totalPages"
      title="Next page"
      aria-label="Go to next page"
    >
      <span class="svg-icon" style="--url: url('assets/icons/chevron-right.svg');" aria-hidden="true"></span>
    </button>

    <span class="pagination-info" aria-live="polite">
      {{ currentPage }} / {{ totalPages }} ({{ totalItems }})
    </span>
  </div>
</div>

<app-modal [isOpen]="showQRModal" title="QR Code" (closeModal)="closeQRModal()">
  <div class="qr-modal-body">
    <div class="qr-display">
      <img *ngIf="selectedLink?.qr_code" [src]="selectedLink!.qr_code" alt="QR Code" />
    </div>
    <div class="qr-link-info">
      <span class="qr-short-url">{{ selectedLink ? getDisplayUrl(selectedLink.url) : '' }}</span>
    </div>
    <p class="qr-description">Scan this QR code to access your short link</p>
    <button class="qr-download-btn" (click)="downloadQR()" *ngIf="selectedLink?.qr_code">
      <span class="svg-icon" style="--url: url('assets/icons/download.svg'); width: 14px; height: 14px;"></span>
      Download QR Code
    </button>
  </div>
</app-modal>

<app-modal [isOpen]="showEditModal" title="Edit Link" (closeModal)="closeEditModal()">
  <form [formGroup]="editForm" (ngSubmit)="saveEdit()" autocomplete="off">
    <div class="form-group">
      <label>Destination URL</label>
      <app-input
        type="url"
        formControlName="target_url"
        [required]="true"
        tooltip="Destination URL"
        autocomplete="url"
      ></app-input>
      <div class="error-message" *ngIf="editForm.get('target_url')?.invalid && editForm.get('target_url')?.touched">
        <span *ngIf="editForm.get('target_url')?.errors?.['required']">Destination URL is required</span>
        <span *ngIf="editForm.get('target_url')?.errors?.['pattern']">Please enter a valid URL (starting with http:// or https://)</span>
      </div>
    </div>
    <app-button
      type="submit"
      label="Save Changes"
      [loading]="editLoading"
      [disabled]="editForm.invalid || editLoading"
      tooltip="Save"
    ></app-button>
  </form>
</app-modal>

<app-modal [isOpen]="showAnalyticsModal" title="Link Analytics" (closeModal)="closeAnalyticsModal()">
  <div class="analytics-modal-body">
    <div *ngIf="analyticsLoading" class="analytics-loader">
      <div class="loader"></div>
      <p>Loading analytics...</p>
    </div>
    <div *ngIf="!analyticsLoading && analytics" class="analytics-content">
      <div class="analytics-link-info" *ngIf="selectedLink">
        <span class="analytics-short-url">{{ getDisplayUrl(selectedLink.url) }}</span>
      </div>
      <div class="analytics-summary">
        <div class="summary-stat">
          <span class="stat-value">{{ analytics.total_clicks }}</span>
          <span class="stat-label">Total Clicks</span>
        </div>
        <div class="summary-stat">
          <span class="stat-value">{{ analytics.unique_clicks }}</span>
          <span class="stat-label">Unique Visitors</span>
        </div>
      </div>
      
      <div class="analytics-grid">
        <div class="analytics-section" *ngIf="analytics.clicks_by_os && analytics.clicks_by_os.length > 0">
          <h3>
            <span class="svg-icon" style="--url: url('assets/icons/smartphone.svg'); width: 14px; height: 14px;"></span>
            Operating Systems
          </h3>
          <ul class="analytics-list">
            <li *ngFor="let item of analytics.clicks_by_os">
              <span class="item-name">{{ item.item }}</span>
              <span class="item-count">{{ item.count }}</span>
            </li>
          </ul>
        </div>
        
        <div class="analytics-section" *ngIf="analytics.clicks_by_browser && analytics.clicks_by_browser.length > 0">
          <h3>
            <span class="svg-icon" style="--url: url('assets/icons/globe.svg'); width: 14px; height: 14px;"></span>
            Browsers
          </h3>
          <ul class="analytics-list">
            <li *ngFor="let item of analytics.clicks_by_browser">
              <span class="item-name">{{ item.item }}</span>
              <span class="item-count">{{ item.count }}</span>
            </li>
          </ul>
        </div>
      </div>
      
      <div class="analytics-empty" *ngIf="analytics.total_clicks === 0">
        <p>No click data available yet. Share your link to start tracking!</p>
      </div>
    </div>
  </div>
</app-modal>
